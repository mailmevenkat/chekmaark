<!Doctype html>
<html>
  <head>
      <title>Chekmaark: Manage tasks using Emails</title>
      <link rel="shortcut icon" type="image/x-icon" href="images/favicon.ico">
      
      <!-- CSS -->
      <link rel="stylesheet" type="text/css" href="semantic/dist/semantic.min.css">
      
      <!-- FONTS -->
      <!-- FONTS -->
      <link href='https://fonts.googleapis.com/css?family=Poiret+One' rel='stylesheet' type='text/css'>
      <link href='https://fonts.googleapis.com/css?family=Satisfy' rel='stylesheet' type='text/css'>
      
      <style>
          .gmail_extra {
              display: none;
          }
      </style>
      
      <!-- JS -->
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
      <script src="semantic/dist/semantic.min.js"></script>
      <script src="//www.parsecdn.com/js/parse-1.6.14.min.js"></script>
      <script src="js/init.js"></script>
      <script src="js/task.js"></script>
      <script src="js/localDB.js"></script>
      <script src="js/gmail.js"> </script>
       <script type="text/javascript">
        AuthListener = function(isAuthenticated, authResult) {
            if(!isAuthenticated) {
                window.location = "index.html";
            } else {
                $(document).ready(function(){
                    var queryString = (document.URL).split("?");
                    var replyTo = null;
                    var replyCc = null;
                    var replySubject = "RE: ";
                    if(queryString.length > 1) {
                        var thread_id = queryString[1];
                        var conversations = $("#conversations");
                        getThread(thread_id, function(response) {
                           if(response.hasOwnProperty("messages")) {
                               for(i in response.messages) {
                                   var message = response.messages[i];
                                   var body = getBody(message.payload);
                                   if(i == 0) {
                                        var subject = getHeader(message.payload.headers, "Subject");
                                        replySubject += subject;
                                        console.log("To" , replyTo, "Subject", replySubject, "Cc", replyCc);
                                        if(isATask(subject)) {
                                            $("#title").html(subject);
                                            $("#desc").html(body);
                                        } else {
                                            $("#title").html(subject);
                                        }
                                   } else {
                                       conversations.append('<div class="item">' +
                                               '<div class="content"><div class="description">' + body
                                                  + '</div> </div> </div>');
                                   }
                                   
                                   if(i == response.messages.length - 1) {
                                        replyTo = getHeader(message.payload.headers, "To");
                                        replyCc = getHeader(message.payload.headers, "Cc");
                                        console.log("To" , replyTo, "Subject", replySubject, "Cc", replyCc);
                                   }
                               }
                           }
                       });
                       
                        $("#reply").click(function(){
                            var message = $("#message").val();
                            var email = makeEmail(replyTo, replyCc, replySubject, message);
                            replyMessage(email, thread_id, function(response) {
                                if(response.hasOwnProperty("threadId")) {
                                    conversations.append('<div class="item">' +
                                           '<div class="content"><div class="description">' + message
                                              + '</div> </div> </div>');
                                    $("#message").val("");
                                }
                            });
                       });
                    }
                });
            }
        };  
        </script>
      <script src="https://apis.google.com/js/client.js?onload=authorize"> </script>
  </head>
  <body>
      <div class="ui fixed menu">
            <a class="item"  href = "dashboard.html">
              <i class="angle left icon"></i>
            </a>
            <div class="header item">
              <h2 class="ui header" style="font-family: 'Poiret One';">Chekmaark</h2>
            </div>
            <a class="right item"  target="_blank" href = "https://groufye.com" >
                <h3 class = "ui header" style="font-family: 'Satisfy', cursive;">by groufye</h3>
            </a>
      </div>
      <div class="ui padded text container" style="margin-top: 70px;">
          <h2 class="ui header" id = "title"></h2>
          <h2 class="ui header" id = "desc"></h2>
          <div id="conversations" class="ui relaxed divided list">
                <div class = ""></div>
          </div>
            <div class="ui bound bottom sticky form" style="bottom: 10px; width: 380px;">
              <div class="field">
                <textarea rows="2" placeholder="Type in a reply..." style="resize:none;" id="message"></textarea>
              </div>
               <button class="ui green basic button" type="button" id="reply">Reply</button>
            </div>
      </div>
  </body>
</html>