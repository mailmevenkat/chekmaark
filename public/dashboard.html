<!Doctype html>
<html>
  <head>
      <title>Chekmaark: Manage tasks using Emails</title>
      <link rel="shortcut icon" type="image/x-icon" href="images/favicon.ico">
      <!-- CSS -->
      <link rel="stylesheet" type="text/css" href="semantic/dist/semantic.min.css">
      <!-- FONTS -->
      <link href='https://fonts.googleapis.com/css?family=Poiret+One' rel='stylesheet' type='text/css'>
      <link href='https://fonts.googleapis.com/css?family=Satisfy' rel='stylesheet' type='text/css'>
      
      
      <!-- JS -->
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
      <script src="semantic/dist/semantic.min.js"></script>
      <script src="//www.parsecdn.com/js/parse-1.6.14.min.js"></script>
      <script src="js/init.js"></script>
      <script src="js/task.js"></script>
      <script src="js/localDB.js"></script>
      <script src="js/gmail.js"> </script>
       <script type="text/javascript">
        AuthListener = function(isAuthenticated, authResult) {
            if(!isAuthenticated) {
                window.location = "index.html";
            } else {
                $(document).ready(function(){
                    var today = new Date().toISOString().split('T')[0];
                    document.getElementsByName("task-due-date")[0].setAttribute('min', today);
                    
                    //Filter task
                    $('#filterTask').dropdown({
                        onChange: function(value, text, choice) {
                            taskFilterer(text);
                        }
                    });
                    
                    function taskFilterer(text) {
                        $('#taskList > div').each(function () {
                            if(text == "All") {
                                this.style.display = "flex";
                            } else if(text == "Pending") {
                                if(this.id == "statusPending")
                                    this.style.display = "flex";
                                else
                                    this.style.display = "none";
                            } else if(text == "Completed") {
                                if(this.id == "statusCompleted")
                                    this.style.display = "flex";
                                else
                                    this.style.display = "none";
                            } else if(text == "Favorite") {
                                if(this.className.match(/(?:^|\s)statusFavorite(?!\S)/))
                                    this.style.display = "flex";
                                else
                                    this.style.display = "none";
                            }
                        });
                    }
                    
                    // Task helper function
                    function taskListData(threadId, status_type, subject, snippet, favorite, duedate, fromUname, toUname, status_icon, favorite_color, status_completed_color, objectid, status_completed) {
                        var setFav = favorite? "statusFavorite": "";
                        return '<div class="ui blue card ' + setFav + '" data-thread="' + threadId + '" id = "status' + status_type + '"> <div class="content"><div class="header">' + subject + '</div><div class="meta"><span class="right floated time">' + duedate +'</span></div><div class="description"><p>' + snippet + '</p></div></div><div class="extra content"><div class="meta"><span class="category">Assigned to ' + toUname + '</span><br><span class="category">Assigned by ' + fromUname + '</span></div></div><div class="extra content"><span class="left floated" id="statusShow"><i class="' + status_icon + ' icon"></i>' + status_type + '</span><span class="right floated"><i class="star ' + favorite_color + ' icon" id="favorite" data-thread=' + threadId + ' data-fav=' + favorite + '></i></span></div><div class="ui bottom attached ' + status_completed_color + ' button" id="complete"  data-thread=' + threadId + ' data-object= ' + objectid + '><i class="checkmark icon"></i>' + status_completed + '</div></div>'
                    }
                    
                    // Add new task
                    $("#addNewTask").click(function() {
                       $("#addTask")
                       .modal({
                            closable  : false,
                            onApprove : function() {
                                var form = $("#newTaskForm");
                                form.addClass("loading");
                                var subject = $("input[name=task-title]").val();
                                var message = $("textarea[name=task-desc]").val();
                                var to = $("input[name=task-to]").val();
                                var cc = $("input[name=task-cc]").val();
                                var date = $("input[name=task-due-date]").val();
                                var duedate  = "";
                                if(duedate.seconds < 0) { 
                                    duedate = "Deadline ended!";
                                } else if(status == TASK_STATUS.PENDING) {
                                    if(isNaN(duedate.total)) {
                                        duedate = "";
                                    } else {
                                        duedate = duedate.days + "d " + duedate.hours + " h " + duedate.minutes + "m " + duedate.seconds + "s ";
                                    }
                                } else {
                                    duedate = "";
                                }
                                createTask(date, function(object) {
                                    var email = makeEmail(to, cc, subject + " #CMK" + object.id, message);
                                    sendMessage(email, function(response) {
                                        modifyThread(response.threadId, [GMAIL_LABELS.important], [], function(response) {
                                            $("#taskList").prepend(taskListData(response.threadId, TASK_STATUS_NAME[0], subject, message.substring(0, message.length > 100? 100: message.length), false, duedate, "You", to, "time", "", "", object.id, "Complete task"));
                                            form.removeClass("loading"); 
                                            $("#addTask").modal('hide');
                                        });
                                    });
                                });
                                return false;
                            }
                          }).modal('show'); 
                    });
                    
                    
                    $(document.body).on("click", "#taskList #complete", function(event) {
                        var button = $(this);
                        var prev = button.prev();
                        var prevChild = prev.children(".left");
                        var thread = button.data("thread");
                        var objectId = button.data("object");
                        button.addClass("loading");
                        getTask(objectId, function(object) {
                            if(object != null) {
                                var status = object.attributes.status;
                                if(status == TASK_STATUS.PENDING) {
                                    completeTask(object, function(object) { 
                                        modifyThread(thread, [], [GMAIL_LABELS.important], function(response) {
                                            button.addClass("green");
                                            prevChild.html('<i class ="checkmark icon"></i> Completed');
                                            button.html('<i class="checkmark icon"></i>Completed</div>');
                                            button.removeClass("loading");
                                        });  
                                    });
                                } else {
                                    incompleteTask(object, function(object) { 
                                        modifyThread(thread, [GMAIL_LABELS.important], [], function(response) {
                                            button.removeClass("green");
                                            prevChild.html('<i class ="time icon"></i> Pending');
                                            button.html('<i class="checkmark icon"></i>Complete task</div>');
                                            button.removeClass("loading");
                                        });  
                                    });
                                }
                            }     
                        });
                    });
                    
                    $(document.body).on("click", "#taskList #favorite", function(event) {
                        var button = $(this);
                        var parent = button.parent().parent().parent();
                        var thread = $(this).data("thread");
                        var fav = $(this).data("fav");
                        button.addClass("loading");
                        if(!fav) {
                            modifyThread(thread, [GMAIL_LABELS.starred], [], function(response) {
                                button.data("fav", true);
                                parent.addClass("statusFavorite");
                                button.addClass("yellow");
                                button.removeClass("grey");
                                button.removeClass("loading");
                            });
                        } else {
                            modifyThread(thread, [], [GMAIL_LABELS.starred], function(response) {
                                button.data("fav", false);
                                parent.removeClass("statusFavorite");
                                button.addClass("grey");
                                button.removeClass("yellow");
                                button.removeClass("loading");
                            });
                        }
                        
                    });
                    
                    setNextPageTokenForThreads(null); //Initiate to false by default
                    var LOCKEDINBOX = false;
                    var LOCKEDSENT = false;
                    function fetchListFromMail() {
                        $("#mainContainer").addClass("loading");
                        if(LOCKEDINBOX || LOCKEDSENT) return;
                        LOCKEDINBOX = true;
                        LOCKEDSENT = true;
                        listAllThreadsFromInbox(getNextPageTokenForThreads(), function(response) {
                                       var taskList = $("#taskList");
                                       var convoList = $("#convoList");
                                       setNextPageTokenForThreads(response.nextPageToken);
                                       if(response.hasOwnProperty("threads")) {
                                           var threadLength = response.threads.length;
                                           for(j in response.threads) {
                                               getThread(response.threads[j].id, function(response) {
                                                   if(response.hasOwnProperty("messages")) {
                                                       for(i in response.messages) {
                                                           var message = response.messages[i];
                                                           var subject = getHeader(message.payload.headers, "Subject");
                                                           var snippet = response.messages[i].snippet;
                                                           var body = getBody(message.payload);
                                                           var labelIds = message.labelIds;
                                                           var favorite = $.inArray(GMAIL_LABELS.starred, labelIds) > -1;
                                                           var favorite_color = favorite? "yellow": "grey";

                                                           var from = getHeader(message.payload.headers, "From");
                                                           if(from.startsWith("<")) {
                                                                var fromFirst = from.substring(1, 2);
                                                                var fromUname = from.substring(1, from.split('@')[0].length);
                                                           } else {
                                                                var fromFirst = from.substring(0, 1);
                                                                var fromUname = from.substring(0, from.split('<')[0].length);
                                                           }

                                                           var to = getHeader(message.payload.headers, "To");
                                                           var tos = to.split(",");
                                                           var toUname = "";
                                                           for(i in tos) {
                                                               if(tos[i].startsWith("<")) {
                                                                    toUname += tos[i].substring(1, from.split('@')[0].length);
                                                               } else {
                                                                    toUname += tos[i].substring(0, from.split('<')[0].length + 1);
                                                               }
                                                               if(i != tos.length - 1) {
                                                                   toUname += ", ";
                                                               }
                                                           }

                                                           if(isATask(subject)) {
                                                               $("#placeHolderTask").css("display", "none");
                                                               getTask(parseTaskIdFromSubject(subject), function(object) {
                                                                   var duedate = "";
                                                                   var status_type = "";
                                                                   var status_icon = "checkmark";
                                                                   var status_completed_color = "green";
                                                                   var status_completed = "Completed";
                                                                   var objectid = ""
                                                                   if(object != null) {
                                                                        objectid = object.id;
                                                                        var deadline = object.attributes.deadline;
                                                                        var status = object.attributes.status;

                                                                        duedate = getTimeRemaining(deadline);
                                                                        if(status == TASK_STATUS.PENDING && duedate.seconds < 0) { 
                                                                            duedate = "Deadline ended!";
                                                                        } else if(status == TASK_STATUS.PENDING) {
                                                                            if(isNaN(duedate.total)) {
                                                                                duedate = "";
                                                                            } else {
                                                                                duedate = duedate.days + "d " + duedate.hours + " h " + duedate.minutes + "m " + duedate.seconds + "s ";
                                                                            }
                                                                        } else {
                                                                            duedate = "";
                                                                        }


                                                                        status_type = TASK_STATUS_NAME[status];

                                                                        if(status == TASK_STATUS.PENDING) {
                                                                            status_icon = "time";
                                                                            status_completed_color = ""
                                                                            status_completed = "Complete task"
                                                                        }
                                                                    }
                                                                   var taskLists = $('#taskList > div');
                                                                   var length = taskLists.length;
                                                                   var toAdd = true;
                                                                   if(taskLists.length == 0) {
                                                                       taskList.append(
                                                                                taskListData(message.threadId, status_type, subject.replace("#CMK" + parseTaskIdFromSubject(subject), ""), snippet, favorite, duedate, fromUname, toUname, status_icon, favorite_color, status_completed_color, objectid, status_completed));
                                                                   }
                                                                   taskLists.each(function(index) {
                                                                       if(this.dataset.thread == message.threadId) {
                                                                           toAdd = false;
                                                                       }
                                                                       if(toAdd && index == length - 1) {
                                                                           taskList.append(
                                                                                taskListData(message.threadId, status_type, subject.replace("#CMK" + parseTaskIdFromSubject(subject), ""), snippet, favorite, duedate, fromUname, toUname, status_icon, favorite_color, status_completed_color, objectid, status_completed));
                                                                       }
                                                                   });
                                                           });
                                                        } else {
                                                               $("#placeHolderConvo").css("display", "none");
                                                               convoList.append(
                                                               '<a href = "message.html?' + message.threadId + '" class="item"> <div class="content"> <div class = "header"><div style="width: 50px; height: 50px; border-radius: 50%; border: 1px red solid; color: red; line-height: 50px; text-align: center;float: left;">' + fromFirst + '</div><div style="width: calc(100% - 80px); margin-left: 10px; float: left; overflow: hidden;"><h4 class="ui header" style="height: 30px; line-height: 30px; width: 100%; overflow: hidden">' + fromUname + ': ' + subject + '</h4><p style="height: 20px; line-height: 20px; color: #ccc; font-size: 13px; font-weight: normal; width: 100%; overflow: hidden">' + snippet + '</p></div><div style="width: 20px; float: left;"><i class="angle right icon" style="height: 50px; line-height: 50px;"></i></div></div></div></a>');
                                                           }
                                                           break; //Execute only once
                                                       }
                                                   }
                                                  if(j == threadLength - 1) {
                                                    console.log("Removing");
                                                    $("#mainContainer").removeClass("loading");
                                                  }
                                               }); 
                                           }
                                           if(threadLength < 0) {
                                                $("#mainContainer").removeClass("loading");
                                           }
                                       }
                                LOCKEDINBOX = false;
                        });
                    
                        listAllThreadsFromSent(getNextPageTokenForThreads(), function(response) {
                                       var taskList = $("#taskList");
                                       if(response.hasOwnProperty("threads")) {
                                           for(i in response.threads) {
                                               getThread(response.threads[i].id, function(response) {
                                                   if(response.hasOwnProperty("messages")) {
                                                       for(i in response.messages) {
                                                           var message = response.messages[i];
                                                           var subject = getHeader(message.payload.headers, "Subject");
                                                           var snippet = response.messages[i].snippet;
                                                           var body = getBody(message.payload);
                                                           var labelIds = message.labelIds;
                                                           var favorite = $.inArray(GMAIL_LABELS.starred, labelIds) > -1;
                                                           var favorite_color = favorite? "yellow": "grey";

                                                           var from = getHeader(message.payload.headers, "From");
                                                           if(from.startsWith("<")) {
                                                                var fromFirst = from.substring(1, 2);
                                                                var fromUname = from.substring(1, from.split('@')[0].length);
                                                           } else {
                                                                var fromFirst = from.substring(0, 1);
                                                                var fromUname = from.substring(0, from.split('<')[0].length);
                                                           }

                                                           var to = getHeader(message.payload.headers, "To");
                                                           var tos = to.split(",");
                                                           var toUname = "";
                                                           for(i in tos) {
                                                               if(tos[i].startsWith("<")) {
                                                                    toUname += tos[i].substring(1, from.split('@')[0].length);
                                                               } else {
                                                                    toUname += tos[i].substring(0, from.split('<')[0].length + 1);
                                                               }
                                                               if(i != tos.length - 1) {
                                                                   toUname += ", ";
                                                               }
                                                           }

                                                           if(isATask(subject)) {
                                                               $("#placeHolderTask").css("display", "none");
                                                               getTask(parseTaskIdFromSubject(subject), function(object) {
                                                                   var duedate = "";
                                                                   var status_type = "";
                                                                   var status_icon = "checkmark";
                                                                   var status_completed_color = "green";
                                                                   var status_completed = "Completed";
                                                                   var objectid = ""
                                                                   if(object != null) {
                                                                        objectid = object.id;
                                                                        var deadline = object.attributes.deadline;
                                                                        var status = object.attributes.status;

                                                                        duedate = getTimeRemaining(deadline);
                                                                        if(status == TASK_STATUS.PENDING && duedate.seconds < 0) { 
                                                                            duedate = "Deadline ended!";
                                                                        } else if(status == TASK_STATUS.PENDING) {
                                                                            if(isNaN(duedate.total)) {
                                                                                duedate = "";
                                                                            } else {
                                                                                duedate = duedate.days + "d " + duedate.hours + " h " + duedate.minutes + "m " + duedate.seconds + "s ";
                                                                            }
                                                                        } else {
                                                                            duedate = "";
                                                                        }


                                                                        status_type = TASK_STATUS_NAME[status];

                                                                        if(status == TASK_STATUS.PENDING) {
                                                                            status_icon = "time";
                                                                            status_completed_color = ""
                                                                            status_completed = "Complete task"
                                                                        }
                                                                    }
                                                                   
                                                                   var taskLists = $('#taskList > div');
                                                                   var length = taskLists.length;
                                                                   var toAdd = true;
                                                                   if(taskLists.length == 0) {
                                                                       taskList.append(
                                                                                taskListData(message.threadId, status_type, subject.replace("#CMK" + parseTaskIdFromSubject(subject), ""), snippet, favorite, duedate, fromUname, toUname, status_icon, favorite_color, status_completed_color, objectid, status_completed));
                                                                   }
                                                                   taskLists.each(function(index) {
                                                                       if(this.dataset.thread == message.threadId) {
                                                                           toAdd = false;
                                                                       }
                                                                       if(toAdd && index == length - 1) {
                                                                           taskList.append(
                                                                                taskListData(message.threadId, status_type, subject.replace("#CMK" + parseTaskIdFromSubject(subject), ""), snippet, favorite, duedate, fromUname, toUname, status_icon, favorite_color, status_completed_color, objectid, status_completed));
                                                                       }
                                                                   });
                                                           });
                                                           break; //Execute only once
                                                       }
                                                    }
                                                   }
                                               });
                                           }
                                       }
                                LOCKEDSENT = false;
                        });
                    };
                    
                    fetchListFromMail();
                    
                    var INFINITE = false;
                    $("#infinite").checkbox({
                        onChecked: function() {
                            INFINITE = true;
                            $("#load-more").css("display", "none");
                            $('#mainContainer').visibility('refresh')
                        },
                        onUnchecked: function() {
                            INFINITE = false;
                            $("#load-more").css("display", "block");
                        }
                    });
                    
                    $("#load-more").click(function() {
                            fetchListFromMail(); 
                            window.location.href = "#top";
                    });
                    
                    $('#mainContainer')
                      .visibility({
                        once: false,
                        // update size when new content loads
                        observeChanges: true,
                        // load content on bottom edge visible
                        onBottomVisible: function() {
                            console.log("Infinite", infinite);
                            if(INFINITE) {
                                fetchListFromMail();
                            }
                        }
                      });
                });
            }
        };  
        </script>
      <script src="https://apis.google.com/js/client.js?onload=authorize"> </script>
  </head>
  <body>
      <div id="headerMenu" class="ui fixed menu">
            <div class="header item">
              <h2 class="ui header" style="font-family: 'Poiret One';"> Chekmaark</h2>
            </div>
            <a class="item"  id = "addNewTask">
              <i class="add icon"></i>
            </a>
            <div class="item">
                <div id="infinite" class="ui toggle checkbox">
                  <input type="checkbox" tabindex="0" class="hidden">
                  <label>Load more on scroll</label>
                </div>
            </div>
            <a class="right item"  target="_blank" href = "https://groufye.com" >
                <h3 class = "ui header" style="font-family: 'Satisfy', cursive;">by groufye</h3>
            </a>
      </div>
      <div class="ui modal" id="addTask"> 
         <i class="close icon"></i>
        <div class="header">Add a task</div>
        <div class="content">
            <form method="post" class="ui form" id="newTaskForm">
                <div class="field">
                    <label>Title</label>
                    <input type="text" name="task-title" placeholder="Title for your task">
                </div>
                <div class="field">
                    <label>Description</label>
                    <textarea name="task-desc" placeholder="Description for your task"></textarea>
                </div>
                <div class="field">
                    <label>Assign to</label>
                    <input type="text" name="task-to" placeholder="Comma separated email(s)">
                </div>
                <div class="field">
                    <label>Team Mates (if any)</label>
                    <input type="text" name="task-cc" placeholder="Team mates email addresses">
                </div>
                <div class="field">
                    <label>Due Date</label>
                    <input type="date" name="task-due-date" placeholder="Due date">
                </div>
                <div class="actions">
                    <div class="ui cancel button">Cancel</div>
                    <button class="ui approve button" type="button">Create</button>
                </div>
             </form>
        </div>
      </div>
      <div id="top" class="ui padded text container"  style="margin-top: 70px;">
              <div id = "mainContainer" class="ui basic segment">
              <h2 class="ui header">Tasks</h2>
              <div class="ui floating labeled icon dropdown button" id = "filterTask">
                  <i class="filter icon"></i>
                  <span class="text">Filter</span>
                  <div class="menu">
                    <div class="item">
                      All
                    </div>
                    <div class="item">
                      Favorite
                    </div>
                    <div class="item">
                      Pending
                    </div>
                    <div class="item">
                      Completed
                    </div>
                  </div>
                </div><br>
              <p id = "placeholder" class="ui" style="text-align:center;">
                    Hit <i class="add icon"></i> to create a new task.
              </p>
              <h3 id="placeHolderTask" class="ui header" style="color: black;"> No tasks! Amazing job! :)<br></h3>
              <div id="taskList" class="ui two cards">
                
              </div>
              <h2 class="ui header">Conversations</h2>
              <h3 id="placeHolderConvo" class="ui header" style="color: black;"> No convos! Finally something you hoped for! :)<br></h3>
              <div id="convoList" class="ui relaxed divided list">

              </div>
                  <button id="load-more" class="ui blue basic button">
                      Load more
                  </button>
              <div style="width: 100%; height: 100px; text-align: center;">
                    <cite style="color: #70b8ff;"><i class="like icon"></i> Made by Groufye. Have an awesome day!</cite><br><br>
              </div>
          </div>
          <script>
                        $("#mainContainer").addClass("loading");
          </script>
          </div>
  </body>
</html>